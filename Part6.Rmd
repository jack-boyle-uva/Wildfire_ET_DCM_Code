---
title: "Part-6-analysis"
author: "Jack Boyle"
date: "2025-12-01"
output:
  html_document: default
  pdf_document: default
---
This is where we have the opportunity to tell the story about our data. So lets do that:
- #1 Show our wildfires (only visualize the ones with ET data)
- #2 Reference hucs
- #3 ~Skiped~
- #4 Delayed Canopy Mortality Breakdown
- #5 ET and P Trends
- #6 Investigating how various classes of Delayed Canopy Mortality effects Evapotranspiration
- #7  Visualizing individual wildfire of various classes



Step 1: Visualize all of the wildfires that we have filtered for

```{r, Step 1, echo=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(sf)
library(maps)
library(scales) 
library(lubridate)

# ==============================================================================
#  LOAD & PREPARE DATA
# ==============================================================================

      path_geo <- "/Users/jackboyle/Downloads/UVA/Code/projects/Wildfire_ET_project/processed_data/#6_post_pre_fire_canopy/raster_method_results/raster_method_pre_post_canopy_fire.gpkg"
      fires_poly <- st_read(path_geo, quiet = TRUE) %>%
        st_transform(crs = 4326) %>%
        st_make_valid() %>% 
        mutate(
          Fire_Year = year(as.Date(Ig_Date)),
              Calculated_Area_Ha = as.numeric(st_area(geom)) / 10000
        )
      
      fires_points <- st_centroid(fires_poly)
      fires_points <- fires_poly %>% 
        st_make_valid() %>% 
        st_centroid()
      us_states <- map_data("state")
      bbox <- st_bbox(fires_poly)

# ==============================================================================
# PLOT 1: THE GEOMETRY MAP (Polygons)
# ==============================================================================
      p1 <- ggplot() +
        geom_polygon(data = us_states, aes(x = long, y = lat, group = group), 
                     fill = "gray95", color = "gray50", linewidth = 0.2) +
        geom_sf(data = fires_poly, fill = "red", color = "black", alpha = 0.6) +
        coord_sf(xlim = c(bbox["xmin"] - 1, bbox["xmax"] + 1), 
                 ylim = c(bbox["ymin"] - 1, bbox["ymax"] + 1)) +
        labs(title = "1. Geographic Distribution (Polygons)",
             subtitle = "Actual shape and location of fire perimeters",
             x = "Longitude", y = "Latitude") +
        theme_minimal() +
        theme(panel.background = element_rect(fill = "lightblue1", color = NA))
      print(p1)

# ==============================================================================
# PLOT 2: THE TIME MAP (Circles + Heat Gradient)
# ==============================================================================
      p2 <- ggplot() +
        geom_polygon(data = us_states, aes(x = long, y = lat, group = group), 
                     fill = "gray70", color = "white", linewidth = 0.3) +
          geom_sf(data = fires_points, aes(color = Fire_Year), size = 2, alpha = 0.8) +
          scale_color_gradientn(
          colors = c("navy", "dodgerblue", "cyan", "gold", "red"),
          name = "Ignition Year",
          breaks = pretty_breaks(n = 5)
        ) +
        guides(color = guide_colorbar(
          title.position = "top", 
          title.hjust = 0.5,
          barwidth = 15, 
          barheight = 0.8,
          frame.colour = "black", 
          ticks.colour = "black"
        )) +
        coord_sf(xlim = c(bbox["xmin"] - 1, bbox["xmax"] + 1), 
                 ylim = c(bbox["ymin"] - 1, bbox["ymax"] + 1)) +
        labs(title = "2. Temporal Distribution",
             subtitle = "Blue = Older Fires | Red = Newer Fires",
             x = "Longitude", y = "Latitude") +
        theme_minimal() +
        theme(
          legend.position = "bottom",
          panel.background = element_rect(fill = "white", color = "black"),
          panel.grid.major = element_line(color = "gray90")
        )
      print(p2)

# ==============================================================================
# PLOT 3: THE SIZE BAR GRAPH
# ==============================================================================
      p3 <- ggplot(fires_poly, aes(x = reorder(Event_ID, Calculated_Area_Ha), y = Calculated_Area_Ha)) +
        # Bars: Using linewidth instead of size for the outline
        geom_col(fill = "firebrick", color = "black", width = 1, linewidth = 0.01) +
        scale_y_continuous(labels = comma) + 
        labs(title = "3. Fire Size Distribution",
             subtitle = paste0("Total Fires: ", nrow(fires_poly)),
             y = "Area (Hectares)", 
             x = "Individual Fires (Ranked Small to Large)") +
        theme_minimal() +
        theme(
          axis.text.x = element_blank(), # 1390 labels would be unreadable
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank()
        )
      print(p3)

```

Step 2: Visulize all the reference HUCS


```{r, Step 2, echo=TRUE, warning=FALSE, message=FALSE}
# ==============================================================================
# Step 2: Visualize Reference HUCs (Cleaned Version)
# ==============================================================================
      library(tidyverse)
      library(sf)
      library(maps)
      path_ref <- "/Users/jackboyle/Downloads/UVA/Code/projects/Wildfire_ET_project/processed_data/#3_Unburned_huc_shape/unburned_huc_polygons.gpkg"
      ref_hucs <- st_read(path_ref, quiet = TRUE) %>%
        st_make_valid() %>% # Crucial to prevent 'degenerate edge' errors
        st_transform(crs = 4326)
      us_states <- map_data("state")
      bbox <- st_bbox(ref_hucs)
      p_ref <- ggplot() +
        geom_polygon(data = us_states, aes(x = long, y = lat, group = group), 
                     fill = "gray95", color = "gray80", linewidth = 0.2) +
        geom_sf(data = ref_hucs, fill = "steelblue", color = "steelblue4", alpha = 0.5, linewidth = 0.1) +
        coord_sf(xlim = c(bbox["xmin"] - 1, bbox["xmax"] + 1), 
                 ylim = c(bbox["ymin"] - 1, bbox["ymax"] + 1)) +
        labs(title = "Unburned Reference HUC Locations",
             subtitle = paste0("Showing ", nrow(ref_hucs), " reference watersheds matched to wildfire events"),
             x = "Longitude", y = "Latitude") +
        theme_minimal() +
        theme(
          panel.background = element_rect(fill = "aliceblue", color = NA),
          panel.grid.major = element_line(color = "white", linewidth = 0.2),
          plot.title = element_text(face = "bold", size = 14)
        )
      
      print(p_ref)
```


Step 4: Delayed Canopy Mortality Breakdown

    Phase #1: Dataset aligment
We start with MTBS to find the burned pixels within a wildfire boundary.
Once we have the burned pixels we get the Total Tree cover from the year before the wildfire (using NLCD).But it's important to know that we only take canopy pixels that have been burned.
Then we get the pixels that lost canopy over time (6 years after the wildfire) using the Hansen Loss dataset, also ontop of the burned pixels.
BUT it should be noted that all datasets were reprojected to a common coordinate system (EPSG:5070 / Albers Equal Area) to ensure accurate area measurements. 
Then we used a "Cookie Cutter" template logic to ensure that every pixel in every dataset lined up perfectly on top of one another. This allows for a direct, pixel-by-pixel comparison between where a fire burned and where a tree died.

    Phase #2: The Database Paradox
The NLCD (Used to find pre-fire canopy) calculated a percentage in ever 30x30m pixel. If the value is .3 we can assume that there is 270m^2 of canopy in that pixel. However, the Hansen "Loss" database assumes that loss occurs in the entire pixel. So there is a paradox that exists where there can be much more loss in canopy than canopy that can physical exist in the landscape. To reconcile this we used a "Corrected Baseline" where total loss in canopy would represent itself as the new pre-fire canopy if --> total loss > pre-fire canopy. corrected_baseline = MAX(NLCD_Canopy, Hansen_Total_Loss).
        
    Phase #3: Temporal Truncation
We gathered 6 years worth of canopy loss data for each wildfire, it is very informative however can be misleading. The longer we watch canopy death play-out, the more probable "noise" in the form of harvesting and/or beetle infestation can corrupt our data. To fix this we adopted the peer-accepted decision to end our canopy analysis at year 3 (Krylov et al., 2014).
        
    Phase #4: Normalization
To normalize the data we calculated the "total canopy loss" by summing the loss in meters squared from every year post fire. Every year's loss was divided by the total loss to get proportions: P0, P1, P2, P3, P3. This style does assume that all potential canopy is lost by at least year 3, which is not entirely true.

    Phase #5: Quality Filtering
In some cases we will see 0 loss in year 2, met with 30% loss in year 3... this scenario is mostly likely caused by of a canopy disturbance that is not directly related to the wildfire, but a different event. Seeing anomalies like this will corrupt our data, to reconcile this we implemented a "Soft Continuity Filter". If wildfires show 0 canopy loss in P1, 0 canopy loss in P2, and >40% canopy loss in P3, then there fires were removed.
dplyr::filter(!(P1 == 0 & P2 == 0 & P3 > 0.40))
Our Quality Filtering method could use some improving.
    
    Phase #6: 10% Filter
Wildfires with low severity and minimal canopy loss present a significant signal-to-noise challenge. Low-magnitude disturbances—specifically those involving less than 10% canopy mortality—are difficult to distinguish from natural inter-annual variability in vegetation phenology and precipitation (Vogelmann et al., 2011). To ensure the integrity of our ecohydrological analysis, we implemented a 10% cumulative severity threshold to isolate clear wildfire signals from background environmental noise
    
      Phase #6: Clustering
We clustered on the normalized proportional loss for each individual year (P0,P1,P2,P3P0,P1,P2,P3). This allows the K-means algorithm to group fires based on their actual temporal shape (the timing of the peak) rather than a forced linear trend. The threshold between k-cluster means is dynamic, they are essentially the Midpoint between the group averages. At the end of this analysis we find the "classification (High, Moderate, Immediate Delayed Canopy)" for every fire.

    Citations:
    Krylov, A., McCarty, J. L., Potapov, P. V., Loboda, T. V., Tyukavina, A., Turubanova, S. A., & Hansen, M. C. (2014). Remote sensing estimates of stand-replacement fires in Russia, 2002–2011. Environmental Research Letters, 9(10), 105007. https://doi.org/10.1088/1748-9326/9/10/105007
    
    Vogelmann, J. E., Kost, J. R., Tolk, B., Howard, S., Short, K., Chen, X., Huang, C., G. J., & Zhu, Z. (2011). Monitoring forest changes in the southwestern United States using multitemporal Landsat data. Remote Sensing of Environment, 115(12), 3377–3390. https://doi.org/10.1016/j.rse.2011.08.001


```{r, Step 4, echo=TRUE, warning=FALSE, message=FALSE}



library(tidyverse)
library(sf)
library(scales)
library(viridis)
library(rnaturalearth)
path <- "/Users/jackboyle/Downloads/UVA/Code/projects/Wildfire_ET_project/processed_data/#6_post_pre_fire_canopy/raster_method_results/DCM_analysis/DCM_Classified_ShapeView.gpkg"
fires_sf <- st_read(path, quiet = TRUE) %>% 
  st_make_valid() 
fires_df <- fires_sf %>% st_drop_geometry()
dcm_colors <- c(
  "Immediate (Low Delay)" = "forestgreen", 
  "Moderate Delayed"      = "darkorange", 
  "High Delayed"          = "firebrick"
)

# ==============================================================================
# PLOT #1: RELATIVE MORTALITY FORMATIONS (Single Panel)
# ==============================================================================
      summary_shape <- fires_df %>%
        dplyr::select(DCM_Class, P0, P1, P2, P3) %>%
        tidyr::pivot_longer(cols = starts_with("P"), names_to = "Year", values_to = "Prop") %>%
        dplyr::mutate(Year = as.numeric(str_remove(Year, "P"))) %>%
        dplyr::group_by(DCM_Class, Year) %>%
        dplyr::summarize(Mean_Prop = mean(Prop, na.rm = TRUE), .groups = "drop")
      p1 <- ggplot(summary_shape, aes(x = Year, y = Mean_Prop, color = DCM_Class)) +
        geom_line(linewidth = 2) +
        geom_point(size = 4) +
        scale_color_manual(values = dcm_colors) +
        scale_y_continuous(labels = percent_format(), limits = c(0, 1)) +
        scale_x_continuous(breaks = 0:3, labels = c("Fire", "+1", "+2", "+3")) +
        labs(title = "Plot #1: Relative Mortality Formations",
             subtitle = "Every fire sums to 100% mortality. This shows the machine-learned temporal archetypes.",
             y = "Proportion of Total Mortality", x = "Post-Fire Interval") +
        theme_classic() +
        theme(legend.position = "bottom", plot.title = element_text(face = "bold"))
      print(p1)


# ==============================================================================
# PLOT #2: FACETED SPAGHETTI PLOT (Fitted for Timing)
# ==============================================================================
      plot_data_faceted <- fires_df %>%
        dplyr::select(Event_ID, DCM_Class, P0, P1, P2, P3) %>%
        tidyr::pivot_longer(cols = c(P0, P1, P2, P3), names_to = "Year_Label", values_to = "Proportion") %>%
        dplyr::mutate(Year = as.numeric(str_remove(Year_Label, "P")))
      summary_faceted <- plot_data_faceted %>%
        dplyr::group_by(DCM_Class, Year) %>%
        dplyr::summarize(Mean_Prop = mean(Proportion, na.rm = TRUE), .groups = "drop")
      p2 <- ggplot() +
        geom_line(data = plot_data_faceted, aes(x = Year, y = Proportion, group = Event_ID, color = DCM_Class), 
                  alpha = 0.1, linewidth = 0.3) +
        geom_line(data = summary_faceted, aes(x = Year, y = Mean_Prop, color = DCM_Class), linewidth = 2.2) +
        facet_wrap(~DCM_Class) +
        scale_color_manual(values = dcm_colors) +
        scale_y_continuous(limits = c(0, 1.05), breaks = seq(0, 1, 0.25), labels = number_format(accuracy = 0.01)) +
        scale_x_continuous(breaks = 0:3) +
        labs(title = "Plot #2: Normalized Mortality Trajectories (Faceted)",
             subtitle = "Y-Axis: 1.0 means 100% of the mortality happened in that specific year.",
             y = "Proportion of Total Death", x = "Year (0 = Fire Year)") +
        theme_minimal() + 
        theme(legend.position = "none", strip.text = element_text(face = "bold"),
              plot.title = element_text(face = "bold"), panel.spacing = unit(1.5, "lines"))
      print(p2)

# ==============================================================================
# PLOT #3: MAGNITUDE SPAGHETTI PLOT (Absolute Magnitude - Log Scale)
# ==============================================================================
      plot_magnitude <- fires_df %>%
        dplyr::select(Event_ID, DCM_Class, Y0 = pct_loss_Y0, Y1 = pct_loss_Y1, Y2 = pct_loss_Y2, Y3 = pct_loss_Y3) %>%
        tidyr::pivot_longer(cols = starts_with("Y"), names_to = "Year", values_to = "Pct_Loss") %>%
        dplyr::mutate(Year = as.numeric(str_remove(Year, "Y")))
      summary_magnitude <- plot_magnitude %>%
        dplyr::group_by(DCM_Class, Year) %>%
        dplyr::summarize(Mean_Pct_Loss = mean(Pct_Loss), .groups = "drop")
      p3 <- ggplot() +
        geom_line(data = plot_magnitude, aes(x = Year, y = Pct_Loss, group = Event_ID, color = DCM_Class), 
                  alpha = 0.05, linewidth = 0.3) +
        geom_line(data = summary_magnitude, aes(x = Year, y = Mean_Pct_Loss, color = DCM_Class), linewidth = 1.5) +
        scale_color_manual(values = dcm_colors) +
        scale_y_log10(labels = unit_format(unit = "%", accuracy = 0.1)) + 
        scale_x_continuous(breaks = 0:3, labels = c("Fire", "+1", "+2", "+3")) +
        labs(title = "Plot #3: Mortality Magnitude Trajectories (Log Scale)",
             subtitle = "Absolute percentage of forest lost. Faint lines show individual fire intensity.",
             y = "Mean Canopy Loss (%)", x = "Post-Fire Interval") +
        theme_classic() +
        theme(legend.position = "bottom", plot.title = element_text(face = "bold"))
      print(p3)

# ==============================================================================
# PLOT #4: CLIMATE DRIVERS (Koppen ID Proportions)
# ==============================================================================
      climate_subset <- fires_df %>% 
        group_by(koppen_id) %>% 
        filter(n() >= 10) %>% 
        ungroup()
      p4 <- ggplot(climate_subset, aes(x = koppen_id, fill = DCM_Class)) +
        geom_bar(position = "fill") + 
        scale_fill_manual(values = dcm_colors) +
        scale_y_continuous(labels = percent_format()) +
        labs(title = "Plot #4: DCM Prevalence by Climate Zone",
             subtitle = "Percentage of fire types within major Koppen categories",
             y = "Proportion of Fires", x = "Koppen Climate ID") +
        theme_minimal() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom")
      print(p4)

# ==============================================================================
# PLOT #5: PRE-FIRE DENSITY BOXPLOT
# ==============================================================================
      p5 <- ggplot(fires_df, aes(x = DCM_Class, y = pre_fire_canopy_pct, fill = DCM_Class)) +
        geom_boxplot(alpha = 0.7, outlier.shape = NA) +
        geom_jitter(width = 0.2, alpha = 0.05) + 
        scale_fill_manual(values = dcm_colors) +
        labs(title = "Plot #5: Pre-Fire Canopy Density vs. DCM Classification",
             y = "Pre-Fire Canopy Cover (%)", x = "") +
        theme_classic() +
        theme(legend.position = "none", plot.title = element_text(face = "bold"))
      print(p5)

# ==============================================================================
# PLOT #6: GEOGRAPHIC DISTRIBUTION MAP
# ==============================================================================
      us_map <- ne_states(country = "united states of america", returnclass = "sf") %>%
        filter(!name %in% c("Alaska", "Hawaii")) %>%
        st_transform(5070)
      fires_points <- fires_sf %>% st_centroid()
      p6 <- ggplot() +
        geom_sf(data = us_map, fill = "gray95", color = "white", linewidth = 0.2) +
        geom_sf(data = fires_points, aes(color = DCM_Class), size = 1.2, alpha = 0.5) +
        scale_color_manual(values = dcm_colors) +
        labs(title = "Plot #6: Geographic Distribution of DCM Archetypes",
             color = "Classification") +
        theme_void() + 
        theme(legend.position = "bottom", plot.title = element_text(face = "bold", hjust = 0.5))
      print(p6)


```








Step 5: ET Trends
          
```{r Step_5_ET_Trends, echo=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(sf)
library(scales)
library(viridis)
library(lubridate)
ET_P_full <- read.csv("/Users/jackboyle/Downloads/UVA/Code/projects/Wildfire_ET_project/processed_data/#9_P_ET_data/ET_P_full_dataset.csv")

# ==============================================================================
# PLOT #1: Normalized Annual ET Recovery
# ==============================================================================
      plot1_data <- ET_P_full %>%
        mutate(
          Water_Year = if_else(Month >= 10, Year + 1, Year),
          Fire_Year_Actual = year(as.Date(Ig_Date)),
          Rel_WY = Water_Year - Fire_Year_Actual
        ) %>%
        group_by(Event_ID, Rel_WY) %>%
        summarize(Annual_Sum_ET = sum(ET_Fire_mm, na.rm = TRUE),
                  Month_Count = n(), .groups = "drop") %>%
        filter(Month_Count == 12, Rel_WY >= -5 & Rel_WY <= 5) %>%
        group_by(Event_ID) %>%
        mutate(Baseline = mean(Annual_Sum_ET[Rel_WY < 0], na.rm = TRUE),
               ET_Norm = Annual_Sum_ET / Baseline) %>%
        ungroup()
      global_summary <- plot1_data %>%
        group_by(Rel_WY) %>%
        summarize(
          Mean_ET = mean(ET_Norm, na.rm = TRUE),
          se_ET = sd(ET_Norm, na.rm = TRUE) / sqrt(n()),
          ci_lower = Mean_ET - (1.96 * se_ET),
          ci_upper = Mean_ET + (1.96 * se_ET),
          .groups = "drop"
        )
      P1_5 <- ggplot() +
        geom_line(data = plot1_data, aes(x = Rel_WY, y = ET_Norm, group = Event_ID), color = "gray80", alpha = 0.3, linewidth = 0.2) +
        geom_ribbon(data = global_summary, aes(x = Rel_WY, ymin = ci_lower, ymax = ci_upper), fill = "steelblue", alpha = 0.3) +
        geom_line(data = global_summary, aes(x = Rel_WY, y = Mean_ET), color = "steelblue", linewidth = 1.5) +
        geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
        geom_hline(yintercept = 1.0, linetype = "dotted", color = "black") +
        scale_y_continuous(labels = percent_format(), limits = c(0, 1.8)) +
        scale_x_continuous(breaks = -5:5) +
        labs(title = "Plot #1: Normalized Annual ET Recovery", y = "Annual ET (% of Normal)", x = "Water Year") +
        theme_classic()
      print(P1_5) 

# ==============================================================================
# PLOT #2: Reference ET Stability
# ==============================================================================
      plot2_data <- ET_P_full %>%
        mutate(
          Water_Year = if_else(Month >= 10, Year + 1, Year),
          Fire_Year_Actual = year(as.Date(Ig_Date)),
          Rel_WY = Water_Year - Fire_Year_Actual
        ) %>%
        group_by(Event_ID, Rel_WY) %>%
        summarize(Annual_Sum_ET_Ref = sum(ET_Ref_mm, na.rm = TRUE),
                  Month_Count = n(), .groups = "drop") %>%
        filter(Month_Count == 12, Rel_WY >= -5 & Rel_WY <= 5) %>%
        group_by(Event_ID) %>%
        mutate(Baseline = mean(Annual_Sum_ET_Ref[Rel_WY < 0], na.rm = TRUE),
               ET_Norm_Ref = Annual_Sum_ET_Ref / Baseline) %>%
        ungroup()
      ref_summary <- plot2_data %>%
        group_by(Rel_WY) %>%
        summarize(Mean_ET = mean(ET_Norm_Ref, na.rm = TRUE),
                  se_ET = sd(ET_Norm_Ref, na.rm = TRUE) / sqrt(n()),
                  ci_lower = Mean_ET - (1.96 * se_ET),
                  ci_upper = Mean_ET + (1.96 * se_ET), .groups = "drop")
      P2_Ref <- ggplot() +
        geom_line(data = plot2_data, aes(x = Rel_WY, y = ET_Norm_Ref, group = Event_ID), color = "gray85", alpha = 0.4, linewidth = 0.2) +
        geom_ribbon(data = ref_summary, aes(x = Rel_WY, ymin = ci_lower, ymax = ci_upper), fill = "darkolivegreen", alpha = 0.3) +
        geom_line(data = ref_summary, aes(x = Rel_WY, y = Mean_ET), color = "darkolivegreen", linewidth = 1.5) +
        geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 1) +
        geom_hline(yintercept = 1.0, linetype = "dotted", color = "black") +
        scale_y_continuous(labels = percent_format(), limits = c(0, 1.8)) +
        labs(title = "Plot #2: Reference ET Stability", y = "Annual Ref ET (%)", x = "Water Year") +
        theme_classic()
      print(P2_Ref) 

# ==============================================================================
# PLOT #3: Decoupling of ET from Precipitation
# ==============================================================================
      plot3_data <- ET_P_full %>%
        mutate(
          Water_Year = if_else(Month >= 10, Year + 1, Year),
          Fire_Year_Actual = year(as.Date(Ig_Date)),
          Rel_WY = Water_Year - Fire_Year_Actual
        ) %>%
        group_by(Event_ID, Rel_WY) %>%
        summarize(
          sum_ET_F = sum(ET_Fire_mm, na.rm = TRUE),
          sum_ET_R = sum(ET_Ref_mm, na.rm = TRUE),
          sum_P_F  = sum(P_Burned_mm, na.rm = TRUE),
          sum_P_R  = sum(P_Ref_mm, na.rm = TRUE),
          Month_Count = n(), .groups = "drop"
        ) %>%
        filter(Month_Count == 12, Rel_WY >= -5 & Rel_WY <= 5) %>%
        group_by(Event_ID) %>%
        mutate(
          Norm_ET_Fire = sum_ET_F / mean(sum_ET_F[Rel_WY < 0], na.rm = TRUE),
          Norm_ET_Ref  = sum_ET_R / mean(sum_ET_R[Rel_WY < 0], na.rm = TRUE),
          Norm_P_Fire  = sum_P_F / mean(sum_P_F[Rel_WY < 0], na.rm = TRUE),
          Norm_P_Ref   = sum_P_R / mean(sum_P_R[Rel_WY < 0], na.rm = TRUE)
        ) %>%
        ungroup()
      summary_3 <- plot3_data %>%
        group_by(Rel_WY) %>%
        summarize(across(starts_with("Norm"), mean, na.rm = TRUE), .groups = "drop")
      P3_Precip <- ggplot(summary_3, aes(x = Rel_WY)) +
        geom_line(aes(y = Norm_P_Fire, color = "Precipitation (Fire)"), linewidth = 1.2, linetype = "dashed") +
        geom_line(aes(y = Norm_P_Ref, color = "Precipitation (Ref)"), linewidth = 1.2, linetype = "dotted") +
        geom_line(aes(y = Norm_ET_Ref, color = "ET (Reference)"), linewidth = 1.5) +
        geom_line(aes(y = Norm_ET_Fire, color = "ET (Burned)"), linewidth = 2) +
        geom_vline(xintercept = 0, linetype = "solid", color = "black", alpha = 0.3) +
        geom_hline(yintercept = 1.0, linetype = "solid", color = "black", alpha = 0.5) +
        scale_color_manual(values = c("ET (Burned)"="firebrick", "ET (Reference)"="darkolivegreen", 
                                      "Precipitation (Fire)"="steelblue", "Precipitation (Ref)"="skyblue")) +
        scale_y_continuous(labels = percent_format(), limits = c(0.4, 1.2)) +
        scale_x_continuous(breaks = -5:5) +
        labs(title = "Plot #3: ET vs Precipitation", y = "% of Normal", x = "Water Year") +
        theme_classic() + theme(legend.position = "bottom")
      print(P3_Precip) 
```





Step 6: Investigating how various classes of Delayed Canopy Mortality effects Evapotranspiration


```{r, Step 6, echo=TRUE, warning=FALSE, message=FALSE}
      library(tidyverse)
      library(sf)
      library(scales)
      library(lubridate)
      library(broom)
      path_labels <- "/Users/jackboyle/Downloads/UVA/Code/projects/Wildfire_ET_project/processed_data/#6_post_pre_fire_canopy/raster_method_results/DCM_analysis/DCM_Classified_ShapeView.gpkg"
      fire_labels <- sf::st_read(path_labels, quiet = TRUE) %>% 
        sf::st_drop_geometry() %>% 
        dplyr::select(Event_ID, DCM_Class)
      processed_et_full <- ET_P_full %>%
        dplyr::inner_join(fire_labels, by = "Event_ID") %>%
        dplyr::mutate(
          Date = as.Date(Date),
          Ig_Date = as.Date(Ig_Date),
          Rel_Month = (year(Date) - year(Ig_Date)) * 12 + (month(Date) - month(Ig_Date)),
          Rel_Year = floor(Rel_Month / 12),
          DCM_Class = factor(DCM_Class, levels = c("High Delayed", "Moderate Delayed", "Immediate (Low Delay)"))
        ) %>%
        dplyr::group_by(Event_ID, DCM_Class, Rel_Year) %>%
        dplyr::summarize(Annual_ET = sum(ET_Fire_mm, na.rm = TRUE),
                         Month_Count = n(), .groups = "drop") %>%
        dplyr::filter((Rel_Year != 0 & Month_Count == 12) | (Rel_Year == 0 & Month_Count >= 6)) %>%
        dplyr::filter(Rel_Year >= -2 & Rel_Year <= 10) %>%
        dplyr::group_by(Event_ID) %>%
        dplyr::mutate(
          Baseline_Val = mean(Annual_ET[Rel_Year < 0], na.rm = TRUE),
          ET_Norm = (Annual_ET / Baseline_Val)
        ) %>%
        dplyr::ungroup()
      dcm_colors <- c("High Delayed"          = "firebrick",
                      "Moderate Delayed"      = "darkorange", 
                      "Immediate (Low Delay)" = "forestgreen")

# ==============================================================================
# PLOT #1: 5-YEAR RECOVERY SUMMARY
# ==============================================================================
      summary_5yr <- processed_et_full %>%
        dplyr::filter(Rel_Year <= 5) %>%
        dplyr::group_by(DCM_Class, Rel_Year) %>%
        dplyr::summarize(Mean_ET = mean(ET_Norm, na.rm = TRUE),
                         se_ET = sd(ET_Norm, na.rm = TRUE) / sqrt(dplyr::n()), .groups = "drop")
      p1 <- ggplot(summary_5yr, aes(x = Rel_Year, y = Mean_ET, color = DCM_Class, fill = DCM_Class)) +
        geom_ribbon(aes(ymin = Mean_ET - 1.96*se_ET, ymax = Mean_ET + 1.96*se_ET), alpha = 0.2, color = NA) +
        geom_line(linewidth = 1.5) + geom_point(size = 2.5) +
        geom_vline(xintercept = 0, linetype = "dashed", color = "black", alpha = 0.5) +
        geom_hline(yintercept = 1.0, linetype = "solid", color = "black", alpha = 0.3) +
        scale_color_manual(values = dcm_colors) + scale_fill_manual(values = dcm_colors) +
        scale_y_continuous(labels = percent_format(), limits = c(0.4, 1.2)) +
        scale_x_continuous(breaks = -2:5) +
        labs(title = "Plot #1: Normalized ET Recovery (Anniversary Year Logic)",
             subtitle = "Every year is a 12-month window starting on the month of fire ignition.",
             y = "Annual ET (% of Pre-Fire Normal)", x = "Anniversary Years Relative to Ignition") +
        theme_classic() + theme(legend.position = "bottom", plot.title = element_text(face = "bold"))
      print(p1)

# ==============================================================================
# PLOT #2: 5-YEAR RECOVERY DYNAMICS (Rate Calculation)
# ==============================================================================
      recovery_rates_5yr <- processed_et_full %>%
        dplyr::filter(Rel_Year >= 1 & Rel_Year <= 4) %>%
        group_by(Event_ID, DCM_Class) %>%
        dplyr::filter(n() >= 3) %>%
        dplyr::do(model = lm(ET_Norm ~ Rel_Year, data = .)) %>%
        dplyr::mutate(Slope = coef(model)[["Rel_Year"]] * 100) %>% 
        dplyr::group_by(DCM_Class) %>%
        dplyr::summarize(Avg_Rate = mean(Slope, na.rm = TRUE), .groups = "drop") %>%
        dplyr::mutate(Label = paste0("Rate: ", ifelse(Avg_Rate > 0, "+", ""), round(Avg_Rate, 2), "% / yr"))
      p2 <- ggplot(processed_et_full %>% dplyr::filter(Rel_Year <= 5), aes(x = Rel_Year, y = ET_Norm * 100)) +
        geom_hline(yintercept = 100, linetype = "dashed", color = "grey70") +
        geom_line(aes(group = Event_ID, color = DCM_Class), alpha = 0.3, linewidth = 0.3) +
        stat_summary(aes(group = DCM_Class), fun = mean, geom = "line", color = "black", linewidth = 1.2) +
        facet_wrap(~DCM_Class) +
        geom_label(data = recovery_rates_5yr, aes(label = Label, x = 1.5, y = 145), fill = "white", fontface = "bold", size = 3) +
        scale_color_manual(values = dcm_colors) +
        scale_x_continuous(breaks = -2:5) +
        coord_cartesian(ylim = c(0, 160)) +
        labs(title = "Plot #2: Individual Recovery Dynamics (Anniversary Logic)",
             y = "Annual ET (% of Pre-Fire Normal)", x = "Anniversary Years Relative to Ignition") +
        theme_bw() + theme(legend.position = "none", plot.title = element_text(face = "bold"),
                           strip.background = element_rect(fill = "gray95"), strip.text = element_text(face = "bold"))
      print(p2)

# ==============================================================================
# PLOT #3: DECADAL RECOVERY SUMMARY
# ==============================================================================
      summary_10yr <- processed_et_full %>%
        dplyr::group_by(DCM_Class, Rel_Year) %>%
        dplyr::summarize(Mean_ET = mean(ET_Norm, na.rm = TRUE),
                         se_ET = sd(ET_Norm, na.rm = TRUE) / sqrt(dplyr::n()), .groups = "drop")
      p3 <- ggplot(summary_10yr, aes(x = Rel_Year, y = Mean_ET, color = DCM_Class, fill = DCM_Class)) +
        geom_ribbon(aes(ymin = Mean_ET - 1.96*se_ET, ymax = Mean_ET + 1.96*se_ET), alpha = 0.2, color = NA) +
        geom_line(linewidth = 1.5) + geom_point() +
        geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) +
        geom_hline(yintercept = 1.0, linetype = "solid", alpha = 0.3) +
        scale_color_manual(values = dcm_colors) + scale_fill_manual(values = dcm_colors) +
        scale_y_continuous(labels = percent_format(), limits = c(0.4, 1.2)) +
        scale_x_continuous(breaks = seq(-2, 10, 1)) +
        labs(title = "Plot #3: Decadal ET Recovery (Anniversary Years)",
             y = "Annual ET (% of Normal)", x = "Years Relative to Ignition") +
        theme_classic() + theme(legend.position = "bottom", plot.title = element_text(face = "bold"))
      print(p3)

# ==============================================================================
# PLOT #4: DECADAL INDIVIDUAL DYNAMICS
# ==============================================================================
      
      recovery_rates_decadal <- processed_et_full %>%
        dplyr::filter(Rel_Year >= 1 & Rel_Year <= 10) %>%
        group_by(Event_ID, DCM_Class) %>%
        dplyr::filter(n() >= 5) %>%
        dplyr::do(model = lm(ET_Norm ~ Rel_Year, data = .)) %>%
        dplyr::mutate(Slope = coef(model)[["Rel_Year"]] * 100) %>% # Convert to percentage points
        dplyr::group_by(DCM_Class) %>%
        dplyr::summarize(Avg_Rate = mean(Slope, na.rm = TRUE), .groups = "drop") %>%
        dplyr::mutate(Label = paste0("Decadal Rate: ", 
                                     ifelse(Avg_Rate > 0, "+", ""), 
                                     round(Avg_Rate, 2), "% / yr"))
      p4 <- ggplot(processed_et_full, aes(x = Rel_Year, y = ET_Norm * 100)) +
        geom_hline(yintercept = 100, linetype = "dashed", color = "grey70") +
        geom_line(aes(group = Event_ID, color = DCM_Class), alpha = 0.3, linewidth = 0.2) +
          stat_summary(aes(group = DCM_Class), fun = mean, geom = "line", color = "black", linewidth = 1.2) +
          geom_label(data = recovery_rates_decadal, 
                   aes(label = Label, x = 4, y = 145), 
                   fill = "white", color = "black", fontface = "bold", size = 3.5) +
        facet_wrap(~DCM_Class) +
        scale_color_manual(values = dcm_colors) +
        scale_x_continuous(breaks = seq(-2, 10, 1)) +
        coord_cartesian(ylim = c(0, 160)) +
        labs(title = "Plot #4: Decadal Individual Recovery Trajectories",
             subtitle = "Rate box represents the average annual ET gain (%) from Year 1 to Year 10.",
             y = "Annual ET (% of Pre-Fire Normal)", 
             x = "Anniversary Years Relative to Ignition") +
        theme_bw() + 
        theme(legend.position = "none", 
              plot.title = element_text(face = "bold", size = 15),
              strip.background = element_rect(fill = "gray95"), 
              strip.text = element_text(face = "bold"),
              panel.grid.minor = element_blank())
      print(p4)
```

Part 7: Visualizing individual wildfire of various classes:
To select the "Power Candidates" for your case studies, we are using a Tiered Selection Logic.
First, we use Euclidean Distance Minimization to identify the top 15 fires in each class that most closely match the "Average Shape" of that group. This ensures the case study is mathematically representative. Second, we filter for fires that have a valid Reference HUC linked to them. Finally, from those representative fires, we select the largest fire by total area. This ensures your case studies aren't just "average" in shape, but are massive, ecologically significant events with high-quality reference data.


```{r, Part 7, echo=TRUE, warning=FALSE, message=FALSE,include=FALSE}
library(tidyverse)
library(sf)
library(terra)
library(tidyterra)
library(maptiles)
library(patchwork)
library(rnaturalearth)
library(scales)
library(lubridate)
library(ggnewscale)

# ==============================================================================
# 1. SETUP PATHS & GLOBAL ASSETS
# ==============================================================================
path_classified <- "/Users/jackboyle/Downloads/UVA/Code/projects/Wildfire_ET_project/processed_data/#6_post_pre_fire_canopy/raster_method_results/DCM_analysis/DCM_Classified_ShapeView.gpkg"
mtbs_root <- "/Users/jackboyle/Downloads/UVA/Database/WILDFIRE_WATERQUALITY/MTBS/composite_data/MTBS_BSmosaics/"
hansen_path <- "/Users/jackboyle/Downloads/UVA/Database/GFC/Loss/Hansen_US_5070_aligned.tif"
et_csv_path <- "/Users/jackboyle/Downloads/UVA/Code/projects/Wildfire_ET_project/processed_data/#9_P_ET_data/ET_P_full_dataset.csv"
r_hansen <- terra::rast(hansen_path)
fires_sf <- st_read(path_classified, quiet = TRUE) %>% st_make_valid()
fires_df <- fires_sf %>% st_drop_geometry()
ET_P_full <- read.csv(et_csv_path)
mtbs_cols <- c("2" = "#7fffd4", "3" = "#ffff00", "4" = "#ff0000")
koppen_lookup <- c(
  "1" = "Tropical Rainforest", "2" = "Tropical Monsoon", "4" = "Hot Desert", 
  "5" = "Hot Semi-Arid", "6" = "Cold Semi-Arid", "7" = "Hot Desert", 
  "8" = "Cold Desert", "9" = "Humid Subtropical", "14" = "Dry-Summer Subtropical", 
  "18" = "Hot-Summer Humid Continental", "25" = "Tundra", "26" = "Monsoon-influenced Continental",
  "BWh" = "Hot Desert", "BWk" = "Cold Desert", "BSh" = "Hot Semi-Arid", 
  "BSk" = "Cold Semi-Arid", "Csa" = "Hot-Summer Med.", "Csb" = "Warm-Summer Med."
)
us_states <- ne_states(country = "united states of america", returnclass = "sf") %>% 
  filter(!name %in% c("Alaska", "Hawaii")) %>% st_transform(4326)

# ==============================================================================
# 2. IDENTIFY POWER CANDIDATES
# ==============================================================================
centroids <- fires_df %>% 
  group_by(DCM_Class) %>% 
  summarize(across(c(P0, P1, P2, P3), mean, na.rm = TRUE), .groups = "drop")
case_study_candidates <- fires_df %>%
  filter(!is.na(Incid_Name) & Incid_Name != "" & !is.na(huc12) & pre_fire_canopy_pct >= 10) %>% 
  inner_join(centroids, by = "DCM_Class", suffix = c("", "_mean")) %>%
  mutate(dist = sqrt((P0-P0_mean)^2 + (P1-P1_mean)^2 + (P2-P2_mean)^2 + (P3-P3_mean)^2)) %>%
  group_by(DCM_Class) %>% 
  slice_min(order_by = dist, n = 15) %>% 
  slice_max(order_by = pre_fire_total_area_m2, n = 3) %>% 
  ungroup()
case_study_et_data <- ET_P_full %>%
  dplyr::filter(trimws(Event_ID) %in% trimws(case_study_candidates$Event_ID)) %>%
  dplyr::mutate(Date_dt = as.Date(Date), Ig_Date_dt = as.Date(Ig_Date),
                Rel_Year = floor(interval(Ig_Date_dt, Date_dt) %/% months(1) / 12))

# ==============================================================================
# 3. COMPONENT FUNCTIONS
# ==============================================================================

      create_1_6th_map <- function(fire_id) {
        poly <- fires_sf %>% filter(Event_ID == fire_id)
        yr <- year(as.Date(poly$Ig_Date))
        r_full <- terra::rast(file.path(mtbs_root, yr, paste0("mtbs_CONUS_", yr), paste0("mtbs_CONUS_", yr, ".tif")))
        fire_v <- vect(st_transform(poly, crs(r_full)))
        e <- ext(fire_v); w <- e$xmax-e$xmin; h <- e$ymax-e$ymin
        new_ext <- ext(e$xmin - w*0.1, e$xmin + w*3.0, e$ymin - h*1.0, e$ymax + h*0.1)
        bg <- maptiles::get_tiles(st_as_sfc(st_bbox(new_ext, crs=crs(r_full))), provider="Esri.WorldImagery", zoom=13, crop=T)
        r_p <- project(classify(mask(crop(r_full, e), fire_v), matrix(c(-Inf,1.5,NA,4.5,Inf,NA), ncol=3, byrow=T)), "EPSG:3857", method="near")
        names(r_p) <- "sev"
        ggplot() + geom_spatraster_rgb(data=bg) +
          geom_spatraster(data=as.factor(r_p), aes(fill=sev), alpha = 0.6) +
          scale_fill_manual(values=mtbs_cols, na.translate=F) +
          geom_sf(data=st_transform(poly, 3857), fill=NA, color="white", linewidth=0.8) +
          annotate("label", x=-Inf, y=Inf, label=paste("Delayed Canopy Mortality:", poly$DCM_Class), 
                   hjust=-0.05, vjust=1.5, fill=alpha("black",0.7), color="white", fontface="bold", size=5, label.size=NA) +
          coord_sf(expand=F) + theme_void()
      }
      create_metadata_plot_snug <- function(fire_id) {
        poly <- fires_sf %>% filter(Event_ID == fire_id)
        raw_c <- unlist(strsplit(as.character(poly$koppen_id), "[, ]+")) %>% str_trim()
        translated <- koppen_lookup[raw_c]
        translated[is.na(translated)] <- raw_c[is.na(translated)] # If not in lookup, use raw code
        climate <- paste(unique(translated), collapse = " / ")
        txt <- paste0("Fire: ", poly$Incid_Name, "\nYear: ", year(as.Date(poly$Ig_Date)), "\nClass: ", poly$DCM_Class, 
                      "\nClimate: ", climate, "\nCanopy: ", round(poly$pre_fire_canopy_pct, 1), 
                      "%\nArea: ", comma(round(poly$pre_fire_total_area_m2/10000, 0)), " Ha")
        ggplot() + annotate("text", x=0.01, y=1, label=txt, hjust=0, vjust=1, fontface="bold", size=5) +
          coord_cartesian(xlim=c(0,1), ylim=c(0.72, 1.01), expand=F) + theme_void() +
          theme(panel.border=element_rect(color="black", fill=NA, linewidth=2), plot.margin=margin(5,5,5,5))
      }
      create_locator_sticker <- function(fire_id) {
        poly <- fires_sf %>% filter(Event_ID == fire_id)
        cent <- st_centroid(st_transform(poly, 4326))
        state <- us_states[st_intersects(cent, us_states)[[1]], ]
        ggplot() + geom_sf(data=state, fill="gray95", color="black", linewidth=0.5) +
          geom_sf(data=cent, color="red", size=4) + theme_void() +
          theme(panel.border=element_rect(color="black", fill=NA, linewidth=1.5))
      }
      create_et_line_plot <- function(fire_id, color_choice) {
        df <- case_study_et_data %>% dplyr::filter(trimws(Event_ID) == trimws(fire_id)) %>%
          dplyr::group_by(Rel_Year) %>% summarize(Ann_ET = mean(ET_Fire_mm, na.rm = TRUE) * 12, n = dplyr::n(), .groups = "drop") %>%
          dplyr::filter(n >= 6 & Rel_Year >= -5 & Rel_Year <= 10)
        if(nrow(df) < 2) return(ggplot() + theme_void()) # Return empty if data fails
        pre_avg <- mean(df$Ann_ET[df$Rel_Year < 0], na.rm = TRUE)
        recov_df <- df %>% filter(Rel_Year >= 1) %>% mutate(Pct = (Ann_ET/pre_avg)*100)
        rate_lab <- "Rate: N/A"
        if(nrow(recov_df) >= 3 && is.finite(pre_avg)){
          fit <- lm(Pct ~ Rel_Year, data=recov_df)
          rate_lab <- paste0("Recovery Rate: ", round(coef(fit)[2], 2), "% / yr")
        }
        ggplot(df, aes(x = Rel_Year, y = Ann_ET)) +
          geom_hline(yintercept = pre_avg, linetype = "dashed", color = "gray50") +
          geom_line(color = color_choice, linewidth = 1.5) + geom_point(color = color_choice, size = 3) +
          geom_vline(xintercept = 0, color = "red", linetype = "dotted", linewidth = 1) +
          annotate("label", x = max(df$Rel_Year, na.rm=T), y = max(df$Ann_ET, na.rm=T), 
                   label = rate_lab, hjust = 1.1, vjust = 1.5, fontface = "bold", size = 4) +
          scale_x_continuous(breaks = seq(-5, 10, 1)) + scale_y_continuous(labels = comma) +
          labs(title = "Evapotranspiration Recovery Dynamics", y = "Annual ET Sum (mm/yr)", x = "Years Relative to Fire") + 
          theme_classic() + 
          theme(plot.title = element_text(face="bold", size=14),
                panel.border = element_rect(color = "black", fill = NA, linewidth = 1.5))
      }
      
      create_loss_filmstrip_white <- function(fire_id) {
        poly <- fires_sf %>% filter(Event_ID == fire_id); fire_yr <- year(as.Date(poly$Ig_Date))
        fire_v <- vect(st_transform(poly, 5070)); h_mask <- mask(crop(r_hansen, fire_v), fire_v)
        bg <- maptiles::get_tiles(st_transform(poly, 3857), provider="Esri.WorldImagery", zoom=12, crop=T)
        bg_g <- bg[[1]]*0.299 + bg[[2]]*0.587 + bg[[3]]*0.114
        maps <- purrr::map(0:3, function(y){
          r <- focal(h_mask == (fire_yr+y-2000), w=3, fun="max", na.rm=T); r[r==0] <- NA
          r_p <- project(r, "EPSG:3857", method="near")
          names(r_p) <- "loss"
          ggplot() + geom_spatraster(data=bg_g) + scale_fill_gradient(low="black", high="white", guide="none") +
            new_scale_fill() + geom_spatraster(data=as.factor(r_p), aes(fill=loss), na.translate=F) +
            scale_fill_manual(values=c("1"="#FF0000"), guide="none") + geom_sf(data=st_transform(poly, 3857), fill=NA, color="white", linewidth=0.3) +
            labs(title=paste0("Y", y, ": ", fire_yr+y)) + theme_void() + 
            theme(plot.title=element_text(hjust=0.5, face="bold", size=10, color="black"), plot.background=element_rect(fill="white", color=NA))
        })
        (maps[[1]]|maps[[2]]|maps[[3]]|maps[[4]]) + plot_layout(ncol=4) + 
          plot_annotation(title="Canopy Loss Over Time (Red = Loss)", 
                          theme=theme(plot.title=element_text(face="bold", size=14, hjust=0.5), plot.background=element_rect(fill="white", color="black", linewidth=2)))
      }
      
      # --- SELECT TARGET ---
      PICK_CLASS <- "High Delayed"  # Options: "High Delayed", "Moderate Delayed", "Immediate (Low Delay)"
      PICK_RANK  <- 1               # 1 (Largest), 2, or 3
      selected_fire <- case_study_candidates %>%
        dplyr::filter(DCM_Class == PICK_CLASS) %>%
        dplyr::arrange(desc(pre_fire_total_area_m2)) %>%
        dplyr::slice(PICK_RANK)
      CURRENT_ID <- selected_fire$Event_ID[1]
      CURRENT_COL <- case_when(PICK_CLASS == "High Delayed" ~ "firebrick",
                               PICK_CLASS == "Moderate Delayed" ~ "darkorange",
                               TRUE ~ "forestgreen")
      
      
      print(create_1_6th_map(CURRENT_ID))
      print(create_metadata_plot_snug(CURRENT_ID))
      print(create_locator_sticker(CURRENT_ID))
      print(create_et_line_plot(CURRENT_ID, CURRENT_COL))
      print(create_loss_filmstrip_white(CURRENT_ID))
```




# Final Case Study Results

```{r, Final_Results_Gallery, echo=TRUE, out.width="100%", fig.align="center", warning=FALSE, message=FALSE}
      library(knitr)
      
      path_high <- "/Users/jackboyle/Downloads/UVA/Code/projects/Wildfire_ET_project/results/High_DCM_results.png"
      path_mod  <- "/Users/jackboyle/Downloads/UVA/Code/projects/Wildfire_ET_project/results/Moderate_DCM_results.png"
      path_low  <- "/Users/jackboyle/Downloads/UVA/Code/projects/Wildfire_ET_project/results/Low_DCM_results_final.png"
      if(file.exists(path_high)) {
        include_graphics(path_high)
      } else {
        print("High DCM Image not found at path.")
      }
      
      if(file.exists(path_mod)) {
        include_graphics(path_mod)
      } else {
        print("Moderate DCM Image not found at path.")
      }
      
      if(file.exists(path_low)) {
        include_graphics(path_low)
      } else {
        print("Low DCM Image not found at path.")
      }

```



















Part 8: Building the Random Forest model ....coming soon



































